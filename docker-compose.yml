version: '3.8'
services:
  redis:
    image: redis:7.2-alpine
    container_name: redis
    restart: unless-stopped
    ports:
      - "6379:6379"

  traefik:
    image: traefik:v2.11
    container_name: traefik
    command:
      - --providers.docker
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --api.insecure=true
    ports:
      - "80:80"
      - "443:443"
      - "8080:8080" # Traefik dashboard
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro

  jupyterhub:
    build:
      context: ./jupyterhub
    container_name: jupyterhub
    restart: unless-stopped
    environment:
      - JUPYTERHUB_CRYPT_KEY=your-crypt-key
    depends_on:
      - redis
      - traefik
    ports:
      - "8000:8000"
    volumes:
      - ./jupyterhub_config.py:/srv/jupyterhub/jupyterhub_config.py:ro
    command: ["jupyterhub", "-f", "/srv/jupyterhub/jupyterhub_config.py"]
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.jupyterhub.rule=Host(`localhost`)"
      - "traefik.http.routers.jupyterhub.entrypoints=web"
      - "traefik.http.services.jupyterhub.loadbalancer.server.port=8000"

  user:
    build:
      context: ./user-image
    container_name: user
    restart: unless-stopped
    labels:
      - "traefik.enable=false"
